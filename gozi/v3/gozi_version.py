"""
By: Jason Reaves, Malware Researcher
Script is a simplistic attempt to auto harvest the gozi version number from samples

Feel free to use but please properly attribute if you end up using it!
"""


import yara
import sys
import struct

rules = yara.compile(source='rule gozi_ver {strings: $a1 = {50 68 ?? ?? ?? 00 6a 0?} condition: all of them }')


def get_gozi_ver(data):
	ver = None
	matches = rules.match(data=data)
	if matches != []:
		matches = matches[0].strings
		temp = matches[0][2]
		(dc,dc,ver) = struct.unpack_from('<BBI', temp)
	return ver

if __name__ == "__main__":
	data = open(sys.argv[1], 'rb').read()
	t = get_gozi_ver(data)
	print(t)
